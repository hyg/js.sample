<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="UTF-8"> 
	<script src="FileSaver.min.js"></script>
	<!-- or https://raw.githubusercontent.com/eligrey/FileSaver.js/master/FileSaver.min.js -->
	<script src="openpgp.min.3.js"></script>
	<script>
    var armorpubkey,armorseckey;
    var pubkey,seckey;
    
	function ReadPubKey() {
        var file = document.getElementById("encryptPubKey").files[0];
		var reader = new FileReader();
		reader.onload = function() {
            armorpubkey = this.result;
		}
        
        reader.readAsText(file);
	}

	function ReadSecKey() {
        var file = document.getElementById("encryptSecKey").files[0];
		var reader = new FileReader();
		reader.onload = function() {
            armorseckey = this.result;
		}
        
        reader.readAsText(file);
	}
    
    async function encrypt(){
        var plaintext = prompt("准备加密，请输入明文");
        var plain = document.getElementById("plain");
        var encrypted = document.getElementById("encrypted");
        
        plain.textContent = plaintext;

        var openpgp = window.openpgp;
        pubkey = await openpgp.key.readArmored(armorpubkey);
        const options = {
            message: openpgp.message.fromText(plaintext),       // input as Message object
            publicKeys: pubkey.keys // for encryption
        };
        openpgp.encrypt(options).then(function(ciphertext){
            encrypted.textContent = ciphertext.data;
        }, function(error) {
            alert(error);
        });
    }
	
    async function decrypt(){
        var plain = document.getElementById("plain");
        var encrypted = document.getElementById("encrypted");

        var openpgp = window.openpgp;
        seckey = await openpgp.key.readArmored(armorseckey);
        let seckeyObj = seckey.keys[0];
        let passphrase = prompt("准备解密，请输入密钥口令");
        await seckeyObj.decrypt(passphrase)
        var encryptedtext = await openpgp.message.readArmored(encrypted.textContent)
        const options = {
            message: encryptedtext ,    // parse armored message
            privateKeys: [seckeyObj]                                 // for decryption
        }
        openpgp.decrypt(options).then(function(text){
            alert(text.data);
        }, function(error) {
            alert(error);
        });
    }
    
	</script>
  </head>
  <body>
    <hr/>
    <br/>
	<label>加密 | 读取公钥文件</label><br/>
	<input type="file" id="encryptPubKey" value="读取公钥文件" multiple="" onchange="ReadPubKey()"/>
    <input type="button" id="encrypt" value="加密" onclick="encrypt()"/><br/>
    <input type="file" id="encryptSecKey" value="读取私钥文件" multiple="" onchange="ReadSecKey()"/>
    <input type="button" id="decrypt" value="解密" onclick="decrypt()"/>
	<br/>
    
    <pre>
    <p id="plain"></p>
    <p id="encrypted"></p>
    <p id="sig"></p>
    </pre><br/><br/>
  
  </body>
</html>