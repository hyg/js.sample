<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="UTF-8"> 
	<script src="FileSaver.min.js"></script>
	<!-- or https://raw.githubusercontent.com/eligrey/FileSaver.js/master/FileSaver.min.js -->
	<script src="openpgp.min.3.js"></script>
	<script>
	function ReadPubKey() {
        var file = document.getElementById("encryptPubKey").files[0];
		var reader = new FileReader();
		reader.onload = function() {
            //document.write("公钥：<br/><pre>"+this.result+"</pre><br/><br/>");
            var armorpubkey = document.getElementById("armorpubkey");
            armorpubkey.textContent = this.result;
		}
        
        reader.readAsText(file);
	}

	function ReadSecKey() {
        var file = document.getElementById("encryptSecKey").files[0];
		var reader = new FileReader();
		reader.onload = function() {
            var armorseckey = document.getElementById("armorseckey");
            armorseckey.textContent = this.result;
		}
        
        reader.readAsText(file);
	}
    
    function encrypt(){
        var plaintext = prompt("准备加密，请输入明文");
        var armorpubkey = document.getElementById("armorpubkey");
        var plain = document.getElementById("plain");
        var encrypted = document.getElementById("encrypted");
        
        plain.textContent = plaintext;

        var openpgp = window.openpgp;
        openpgp.key.readArmored(armorpubkey.textContent).then(function(pubkey){
            var options = {
                message: openpgp.message.fromText(plaintext),       // input as Message object
                publicKeys: pubkey.keys // for encryption
            };
            openpgp.encrypt(options).then(function(ciphertext){
                encrypted.textContent = ciphertext.data;
            }, function(error) {
                alert(error);
            });
            
        });
        
    }
    
    async function encrypt1(){
        var plaintext = prompt("准备加密，请输入明文");
        var armorpubkey = document.getElementById("armorpubkey");
        var plain = document.getElementById("plain");
        var encrypted = document.getElementById("encrypted");
        
        plain.textContent = plaintext;

        var openpgp = window.openpgp;
        var pubkey = await openpgp.key.readArmored(armorpubkey.textContent);
        var options = {
            message: openpgp.message.fromText(plaintext),       // input as Message object
            publicKeys: pubkey.keys // for encryption
        };
        openpgp.encrypt(options).then(function(ciphertext){
            encrypted.textContent = ciphertext.data;
        }, function(error) {
            alert(error);
        });
    }
	
    function decrypt(){
        var armorseckey = document.getElementById("armorseckey");
        var plain = document.getElementById("plain");
        var encrypted = document.getElementById("encrypted");

        var openpgp = window.openpgp;
        openpgp.key.readArmored(armorseckey.textContent).then(function(seckeys){
            var passphrase = prompt("准备解密，请输入密钥口令");
            var seckey = seckeys.keys[0];

            seckey.decrypt(passphrase).then(function(){
                openpgp.message.readArmored(encrypted.textContent).then(function(encryptedtext){
                    const options = {
                        message: encryptedtext ,    // parse armored message
                        privateKeys: seckey                                 // for decryption
                    }
                    openpgp.decrypt(options).then(function(text){
                        alert(text.data);
                    }, function(error) {
                        alert(error);
                    });
                });
            },function(error) {
                alert(error);
            });
            
        });
    }
    
	</script>
  </head>
  <body>
    <hr/>
    <br/>
	<label>加密 | 读取公钥文件</label><br/>
	<input type="file" id="encryptPubKey" value="读取公钥文件" multiple="" onchange="ReadPubKey()"/>
    <input type="button" id="encrypt" value="加密" onclick="encrypt1()"/><br/>
    <input type="file" id="encryptSecKey" value="读取私钥文件" multiple="" onchange="ReadSecKey()"/>
    <input type="button" id="decrypt" value="解密" onclick="decrypt()"/>
	<br/>
    
    <pre>
    <p id="armorpubkey"></p>
    <p id="armorseckey"></p>
    <p id="plain"></p>
    <p id="encrypted"></p>
    <p id="sig"></p>
    </pre><br/><br/>
  
  </body>
</html>