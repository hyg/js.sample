<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2PåŠ å¯†é€šä¿¡</title>
    <script src="https://cdn.jsdelivr.net/npm/simple-peer@9.11.1/simplepeer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #333;
        }
        .container {
            width: 90%;
            max-width: 800px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: #4a5568;
            color: white;
            padding: 20px;
            text-align: center;
        }
        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }
        .header .param {
            font-size: 14px;
            opacity: 0.9;
        }
        .content {
            padding: 20px;
            min-height: 400px;
            display: flex;
            flex-direction: column;
        }
        .status {
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
            border: 1px solid #e2e8f0;
        }
        .status.connected {
            background: #c6f6d5;
            border-color: #9ae6b4;
        }
        .status.disconnected {
            background: #fed7d7;
            border-color: #feb2b2;
        }
        .messages {
            flex: 1;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
            background: #f8f9fa;
            min-height: 200px;
        }
        .message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 18px;
            max-width: 80%;
            word-wrap: break-word;
            font-size: 14px;
        }
        .message.own {
            background: #4299e1;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        .message.other {
            background: #edf2f7;
            color: #2d3748;
            margin-right: auto;
            border-bottom-left-radius: 4px;
        }
        .input-area {
            display: flex;
            gap: 10px;
        }
        .input-area input {
            flex: 1;
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
        }
        .input-area input:focus {
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.2);
        }
        .input-area button {
            padding: 0 20px;
            background: #48bb78;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
        }
        .input-area button:hover {
            background: #38a169;
        }
        .input-area button:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
        }
        .help-text {
            font-size: 12px;
            color: #718096;
            text-align: center;
            margin-top: 10px;
        }
        .encryption-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            color: #2f855a;
        }
        .lock-icon {
            color: #2f855a;
        }
        .info-box {
            background: #ebf8ff;
            border: 1px solid #90cdf4;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            font-size: 14px;
            color: #2b6cb0;
        }
        .copy-btn {
            background: #4a5568;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
        }
        .copy-btn:hover {
            background: #2d3748;
        }
        .setup-guide {
            background: #f0fff4;
            border: 1px solid #9ae6b4;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            font-size: 14px;
        }
        .setup-guide h3 {
            color: #2f855a;
            margin-bottom: 10px;
        }
        .setup-guide ul {
            margin-left: 20px;
            margin-top: 5px;
        }
        .setup-guide li {
            margin-bottom: 5px;
        }
        .connection-info {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 10px;
            font-size: 12px;
            color: #4a5568;
            margin-bottom: 10px;
        }
        .connection-info strong {
            color: #2d3748;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            padding: 10px;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 15px;
            border: 1px solid #ffeaa7;
        }
        .retry-btn {
            background: #e53e3e;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
            transition: background 0.2s;
        }
        .retry-btn:hover {
            background: #c53030;
        }
        .debug-log {
            background: #f4f4f4;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            font-size: 12px;
            max-height: 150px;
            overflow-y: auto;
            margin-top: 10px;
            font-family: monospace;
        }
        .debug-log h4 {
            margin-bottom: 5px;
            color: #4a5568;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ç«¯å¯¹ç«¯åŠ å¯†P2Pé€šä¿¡</h1>
            <div class="param">æˆ¿é—´å‚æ•°: <span id="paramDisplay"></span></div>
        </div>
        <div class="content">
            <div class="warning">
                âš ï¸ é‡è¦æç¤ºï¼šè¯·ç¡®ä¿åŒæ–¹éƒ½ä½¿ç”¨HTTPSæˆ–æœ¬åœ°æ–‡ä»¶åè®®(file://)
            </div>
            <div class="info-box">
                <strong>ä½¿ç”¨è¯´æ˜:</strong> å¤åˆ¶å½“å‰é¡µé¢URLåˆ†äº«ç»™å¯¹æ–¹ï¼ŒåŒæ–¹æ‰“å¼€ç›¸åŒé“¾æ¥å³å¯å»ºç«‹è¿æ¥
                <button class="copy-btn" id="copyUrl">å¤åˆ¶é“¾æ¥</button>
            </div>
            <div class="setup-guide">
                <h3>è¿æ¥è®¾ç½®æŒ‡å—:</h3>
                <ul>
                    <li>åŒæ–¹å¿…é¡»æ‰“å¼€å®Œå…¨ç›¸åŒçš„URLå‚æ•°</li>
                    <li>å»ºè®®åœ¨Chromeæˆ–Firefoxæµè§ˆå™¨ä¸­ä½¿ç”¨</li>
                    <li>å¦‚æœè¿æ¥å¤±è´¥ï¼Œå°è¯•åˆ·æ–°é¡µé¢</li>
                    <li>ç¡®ä¿ç½‘ç»œç¯å¢ƒå…è®¸P2Pè¿æ¥</li>
                </ul>
            </div>
            <div id="status" class="status disconnected">ç­‰å¾…è¿æ¥...</div>
            <div id="connectionInfo" class="connection-info" style="display:none;">
                <strong>è¿æ¥çŠ¶æ€:</strong> <span id="connectionStatus">æ­£åœ¨è¿æ¥...</span><br>
                <strong>æœ¬åœ°åœ°å€:</strong> <span id="localAddress">æœªçŸ¥</span>
            </div>
            <div id="messages" class="messages">
                <div class="message other">ç­‰å¾…å…¶ä»–ç”¨æˆ·åŠ å…¥...</div>
            </div>
            <div class="input-area">
                <input type="text" id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯..." disabled>
                <button id="sendBtn" disabled>å‘é€</button>
            </div>
            <div class="help-text">
                <div class="encryption-indicator">
                    <span class="lock-icon">ğŸ”’</span>
                    ç«¯å¯¹ç«¯åŠ å¯†é€šä¿¡ (ä½¿ç”¨AES-256)
                </div>
            </div>
            <button id="retryBtn" class="retry-btn" style="display:none;">é‡æ–°è¿æ¥</button>
            <div class="debug-log">
                <h4>è°ƒè¯•æ—¥å¿—:</h4>
                <div id="debugLog"></div>
            </div>
        </div>
    </div>

    <script>
        // ç¡®ä¿DOMå®Œå…¨åŠ è½½åå†æ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            // æ‰‹åŠ¨è§£æURLå‚æ•°çš„å‡½æ•°
            function parseQueryString() {
                const query = window.location.search.substring(1);
                const params = {};
                if (!query) return params;
                
                const pairs = query.split('&');
                for (let pair of pairs) {
                    const [key, value] = pair.split('=');
                    if (key) {
                        params[decodeURIComponent(key)] = value ? decodeURIComponent(value) : '';
                    }
                }
                return params;
            }

            // è·å–å½“å‰å®Œæ•´URL
            function getCurrentUrl() {
                return window.location.href;
            }

            // å¤åˆ¶æ–‡æœ¬åˆ°å‰ªè´´æ¿
            function copyToClipboard(text) {
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(text).then(() => {
                        alert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
                    }).catch(err => {
                        console.error('å¤åˆ¶å¤±è´¥:', err);
                        fallbackCopyTextToClipboard(text);
                    });
                } else {
                    fallbackCopyTextToClipboard(text);
                }
            }

            // å¤‡ç”¨å¤åˆ¶æ–¹æ³•
            function fallbackCopyTextToClipboard(text) {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = "fixed";
                textArea.style.top = 0;
                textArea.style.left = 0;
                textArea.style.width = '2em';
                textArea.style.height = '2em';
                textArea.style.padding = 0;
                textArea.style.border = 'none';
                textArea.style.outline = 'none';
                textArea.style.boxShadow = 'none';
                textArea.style.background = 'transparent';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    alert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
                } catch (err) {
                    prompt('å¤åˆ¶é“¾æ¥:', getCurrentUrl());
                }
                document.body.removeChild(textArea);
            }

            // æ·»åŠ è°ƒè¯•æ—¥å¿—
            function logDebug(message) {
                console.log(`[DEBUG] ${new Date().toLocaleTimeString()}: ${message}`);
                const debugLog = document.getElementById('debugLog');
                const logEntry = document.createElement('div');
                logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                debugLog.appendChild(logEntry);
                debugLog.scrollTop = debugLog.scrollHeight;
            }

            // ä¸»è¦åŠŸèƒ½å®ç°
            class P2PChat {
                constructor() {
                    this.peer = null;
                    this.param = '';
                    this.isInitiator = false;
                    this.connected = false;
                    this.messageInput = document.getElementById('messageInput');
                    this.sendBtn = document.getElementById('sendBtn');
                    this.messages = document.getElementById('messages');
                    this.status = document.getElementById('status');
                    this.paramDisplay = document.getElementById('paramDisplay');
                    this.connectionInfo = document.getElementById('connectionInfo');
                    this.connectionStatus = document.getElementById('connectionStatus');
                    this.localAddress = document.getElementById('localAddress');
                    this.retryBtn = document.getElementById('retryBtn');
                    
                    // ä½¿ç”¨æŒ‡å®šçš„STUNæœåŠ¡å™¨
                    this.config = {
                        iceServers: [
                            { urls: 'stun:fwa.lifesizecloud.com:3478' },
                            { urls: 'stun:stun.isp.net.au:3478' },
                            { urls: 'stun:stun.freeswitch.org:3478' },
                            { urls: 'stun:stun.voip.blackberry.com:3478' }
                        ],
                        iceTransportPolicy: 'all',
                        bundlePolicy: 'max-bundle',
                        rtcpMuxPolicy: 'require'
                    };

                    this.init();
                }

                init() {
                    logDebug('å¼€å§‹åˆå§‹åŒ–P2PèŠå¤©...');
                    // ä»URLå‚æ•°è·å–æˆ¿é—´ID
                    const params = parseQueryString();
                    this.param = params.room || 'default';
                    this.paramDisplay.textContent = this.param;
                    
                    // ç”ŸæˆåŠ å¯†å¯†é’¥ï¼ˆåŸºäºæˆ¿é—´å‚æ•°ï¼‰
                    this.encryptionKey = CryptoJS.SHA256(this.param).toString();
                    
                    // æ›´æ–°æ ‡é¢˜
                    document.title = `P2PèŠå¤© - ${this.param}`;
                    
                    logDebug(`æˆ¿é—´å‚æ•°: ${this.param}`);
                    logDebug(`åŠ å¯†å¯†é’¥ç”Ÿæˆå®Œæˆ`);
                    
                    // å¼€å§‹P2Pè¿æ¥
                    this.startP2P();
                }

                startP2P() {
                    logDebug('å¼€å§‹å»ºç«‹P2Pè¿æ¥...');
                    // æ˜¾ç¤ºè¿æ¥çŠ¶æ€
                    this.status.textContent = 'æ­£åœ¨å»ºç«‹P2Pè¿æ¥...';
                    this.connectionInfo.style.display = 'block';
                    this.connectionStatus.textContent = 'æ­£åœ¨è¿æ¥...';
                    this.addMessage('ç³»ç»Ÿ', 'æ­£åœ¨å°è¯•å»ºç«‹è¿æ¥ï¼Œè¯·ç¡®ä¿å¯¹æ–¹ä¹Ÿæ‰“å¼€äº†ç›¸åŒå‚æ•°çš„é¡µé¢', false);
                    
                    // åˆ›å»ºPeerè¿æ¥
                    this.createPeer(true);
                }

                createPeer(initiator) {
                    logDebug(`åˆ›å»ºPeerè¿æ¥ï¼Œinitiator=${initiator}`);
                    this.isInitiator = initiator;
                    
                    try {
                        logDebug('å‡†å¤‡åˆ›å»ºSimplePeerå®ä¾‹...');
                        this.peer = new SimplePeer({
                            initiator: initiator,
                            trickle: true,
                            config: this.config,
                            // æ·»åŠ è¶…æ—¶è®¾ç½®
                            timeout: 30000
                        });
                        
                        logDebug('SimplePeerå®ä¾‹åˆ›å»ºæˆåŠŸ');

                        // ç›‘å¬å„ç§äº‹ä»¶
                        this.peer.on('signal', data => {
                            logDebug(`æ”¶åˆ°ä¿¡ä»¤æ•°æ®: ${JSON.stringify(data)}`);
                            if (data.type === 'offer') {
                                this.status.textContent = 'ç­‰å¾…å¯¹æ–¹å“åº”...';
                                this.connectionStatus.textContent = 'ç­‰å¾…å“åº”';
                                this.addMessage('ç³»ç»Ÿ', 'å·²åˆ›å»ºè¿æ¥è¯·æ±‚ï¼Œç­‰å¾…å¯¹æ–¹å“åº”', false);
                                logDebug('å‘é€äº†offerä¿¡å·');
                            } else if (data.type === 'answer') {
                                this.status.textContent = 'è¿æ¥åå•†ä¸­...';
                                this.connectionStatus.textContent = 'åå•†ä¸­';
                                logDebug('æ”¶åˆ°äº†answerä¿¡å·');
                            } else if (data.type === 'candidate') {
                                logDebug(`æ”¶åˆ°ICEå€™é€‰è€…: ${data.candidate?.candidate || 'æ— å€™é€‰è€…'}`);
                                // å¤„ç†ICEå€™é€‰è€…
                                if (data.candidate && data.candidate.candidate) {
                                    const candidate = data.candidate.candidate;
                                    if (candidate.includes('typ host')) {
                                        this.localAddress.textContent = 'æœ¬åœ°ç½‘ç»œ';
                                    } else if (candidate.includes('typ srflx')) {
                                        const ipMatch = candidate.match(/(\d+\.\d+\.\d+\.\d+)/);
                                        if (ipMatch) {
                                            this.localAddress.textContent = ipMatch[1] + ' (NAT)';
                                        }
                                    } else if (candidate.includes('typ relay')) {
                                        this.localAddress.textContent = 'ä¸­ç»§è¿æ¥';
                                    }
                                }
                            }
                        });

                        this.peer.on('connect', () => {
                            logDebug('è¿æ¥å»ºç«‹æˆåŠŸ');
                            this.connected = true;
                            this.status.textContent = 'å·²è¿æ¥ - å¯ä»¥å¼€å§‹èŠå¤©';
                            this.status.className = 'status connected';
                            this.connectionStatus.textContent = 'å·²è¿æ¥';
                            this.messageInput.disabled = false;
                            this.sendBtn.disabled = false;
                            this.retryBtn.style.display = 'none';
                            
                            // å‘é€è¿æ¥æ¶ˆæ¯
                            this.addMessage('ç³»ç»Ÿ', 'P2Pè¿æ¥å·²å»ºç«‹ï¼Œå¯ä»¥å¼€å§‹åŠ å¯†èŠå¤©', false);
                        });

                        this.peer.on('data', data => {
                            logDebug('æ”¶åˆ°æ•°æ®æ¶ˆæ¯');
                            try {
                                // è§£å¯†æ¶ˆæ¯
                                const decryptedHex = CryptoJS.AES.decrypt(data, this.encryptionKey);
                                const decrypted = decryptedHex.toString(CryptoJS.enc.Utf8);
                                if (!decrypted) {
                                    this.addMessage('ç³»ç»Ÿ', 'æ”¶åˆ°æ— æ•ˆæ¶ˆæ¯', false);
                                    return;
                                }
                                const messageData = JSON.parse(decrypted);
                                this.addMessage('å¯¹æ–¹', messageData.text, false);
                            } catch (e) {
                                console.error('è§£å¯†å¤±è´¥:', e);
                                logDebug(`è§£å¯†å¤±è´¥: ${e.message}`);
                                this.addMessage('ç³»ç»Ÿ', 'æ”¶åˆ°åŠ å¯†æ¶ˆæ¯ä½†æ— æ³•è§£å¯†', false);
                            }
                        });

                        this.peer.on('close', () => {
                            logDebug('è¿æ¥å…³é—­');
                            this.connected = false;
                            this.status.textContent = 'è¿æ¥å·²æ–­å¼€';
                            this.status.className = 'status disconnected';
                            this.connectionStatus.textContent = 'å·²æ–­å¼€';
                            this.messageInput.disabled = true;
                            this.sendBtn.disabled = true;
                            this.addMessage('ç³»ç»Ÿ', 'P2Pè¿æ¥å·²æ–­å¼€', false);
                            this.retryBtn.style.display = 'block';
                        });

                        this.peer.on('error', err => {
                            logDebug(`å‘ç”Ÿé”™è¯¯: ${err.message}`);
                            console.error('P2Pé”™è¯¯:', err);
                            
                            // å¿½ç•¥æŸäº›æ— å…³ç´§è¦çš„é”™è¯¯
                            if (err.message.includes('chunk') || err.message.includes('Connection failed.')) {
                                logDebug('å¿½ç•¥çš„è¿æ¥é”™è¯¯');
                                return;
                            }
                            
                            // æ ¹æ®é”™è¯¯ç±»å‹æ˜¾ç¤ºå‹å¥½æç¤º
                            if (err.message.includes('Connection timeout')) {
                                this.status.textContent = 'è¿æ¥è¶…æ—¶';
                                this.connectionStatus.textContent = 'è¶…æ—¶';
                                this.addMessage('ç³»ç»Ÿ', 'è¿æ¥è¶…æ—¶ï¼Œè¯·æ£€æŸ¥åŒæ–¹ç½‘ç»œ', false);
                                this.retryBtn.style.display = 'block';
                            } else if (err.message.includes('Failed to create session description')) {
                                this.status.textContent = 'åå•†å¤±è´¥';
                                this.connectionStatus.textContent = 'åå•†å¤±è´¥';
                                this.addMessage('ç³»ç»Ÿ', 'è¿æ¥åå•†å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', false);
                                this.retryBtn.style.display = 'block';
                            } else {
                                this.status.textContent = 'è¿æ¥é”™è¯¯';
                                this.connectionStatus.textContent = 'é”™è¯¯';
                                this.addMessage('ç³»ç»Ÿ', 'è¿æ¥é‡åˆ°é—®é¢˜: ' + err.message, false);
                                this.retryBtn.style.display = 'block';
                            }
                            
                            this.status.className = 'status disconnected';
                        });
                        
                        logDebug('äº‹ä»¶ç›‘å¬å™¨å·²è®¾ç½®');
                    } catch (error) {
                        logDebug(`åˆ›å»ºPeerå¤±è´¥: ${error.message}`);
                        console.error('åˆ›å»ºPeerå¤±è´¥:', error);
                        this.status.textContent = 'åˆå§‹åŒ–å¤±è´¥: ' + error.message;
                        this.connectionStatus.textContent = 'åˆå§‹åŒ–å¤±è´¥';
                        this.addMessage('ç³»ç»Ÿ', 'æ— æ³•åˆå§‹åŒ–P2Pè¿æ¥: ' + error.message, false);
                        this.retryBtn.style.display = 'block';
                    }
                }

                sendMessage(text) {
                    if (!this.connected || !text.trim()) return;

                    // åˆ›å»ºæ¶ˆæ¯å¯¹è±¡
                    const messageData = {
                        text: text.trim(),
                        timestamp: new Date().toISOString(),
                        from: 'me'
                    };

                    // åŠ å¯†æ¶ˆæ¯
                    const encrypted = CryptoJS.AES.encrypt(JSON.stringify(messageData), this.encryptionKey).toString();
                    
                    // å‘é€åŠ å¯†æ•°æ®
                    try {
                        logDebug('å‘é€åŠ å¯†æ¶ˆæ¯');
                        this.peer.send(encrypted);
                        // æ˜¾ç¤ºæ¶ˆæ¯
                        this.addMessage('æˆ‘', messageData.text, true);
                        // æ¸…ç©ºè¾“å…¥æ¡†
                        this.messageInput.value = '';
                    } catch (error) {
                        logDebug(`å‘é€æ¶ˆæ¯å¤±è´¥: ${error.message}`);
                        console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
                        this.addMessage('ç³»ç»Ÿ', 'å‘é€å¤±è´¥: ' + error.message, false);
                    }
                }

                addMessage(sender, text, isOwn) {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${isOwn ? 'own' : 'other'}`;
                    messageDiv.innerHTML = `<strong>${sender}:</strong> ${this.escapeHtml(text)}`;
                    this.messages.appendChild(messageDiv);
                    
                    // æ»šåŠ¨åˆ°åº•éƒ¨
                    this.messages.scrollTop = this.messages.scrollHeight;
                }

                escapeHtml(text) {
                    const div = document.createElement('div');
                    div.textContent = text;
                    return div.innerHTML;
                }
                
                // é‡æ–°è¿æ¥æ–¹æ³•
                reconnect() {
                    logDebug('å¼€å§‹é‡æ–°è¿æ¥...');
                    this.status.textContent = 'æ­£åœ¨é‡æ–°è¿æ¥...';
                    this.connectionStatus.textContent = 'é‡æ–°è¿æ¥ä¸­...';
                    this.retryBtn.style.display = 'none';
                    this.addMessage('ç³»ç»Ÿ', 'æ­£åœ¨é‡æ–°å»ºç«‹è¿æ¥...', false);
                    
                    // é”€æ¯æ—§è¿æ¥
                    if (this.peer) {
                        this.peer.destroy();
                    }
                    
                    // é‡æ–°åˆ›å»ºè¿æ¥
                    setTimeout(() => {
                        this.createPeer(true);
                    }, 1000);
                }
            }

            // åˆå§‹åŒ–èŠå¤©åº”ç”¨
            const chat = new P2PChat();
            
            // è®¾ç½®å‘é€æŒ‰é’®äº‹ä»¶
            document.getElementById('sendBtn').addEventListener('click', () => {
                const input = document.getElementById('messageInput');
                chat.sendMessage(input.value);
            });
            
            // æ”¯æŒå›è½¦å‘é€
            document.getElementById('messageInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('sendBtn').click();
                }
            });
            
            // å¤åˆ¶é“¾æ¥æŒ‰é’®
            document.getElementById('copyUrl').addEventListener('click', () => {
                copyToClipboard(getCurrentUrl());
            });
            
            // é‡æ–°è¿æ¥æŒ‰é’®
            document.getElementById('retryBtn').addEventListener('click', () => {
                chat.reconnect();
            });
        });
    </script>
</body>
</html>