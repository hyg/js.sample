# XMTP + Qwen AI Chatbot - 需求文档

## 项目概述

本项目旨在创建一个基于XMTP协议的去中心化聊天机器人，该机器人能够：
1. 通过XMTP网络接收用户消息
2. 将用户消息发送给Qwen AI进行智能回复
3. 将AI回复通过XMTP网络发送回用户

## 功能需求

### 核心功能

1. **XMTP消息接收**
   - 连接到XMTP网络
   - 监听来自其他用户的消息
   - 解析接收到的消息内容

2. **Qwen AI集成**
   - 将用户消息发送给Qwen AI API
   - 接收并解析AI回复
   - 处理API错误和异常情况

3. **XMTP消息发送**
   - 将AI回复通过XMTP网络发送回用户
   - 处理消息发送失败的情况

4. **钱包管理**
   - 生成和管理机器人钱包
   - 持久化钱包信息以便重复使用

### 辅助功能

1. **环境配置**
   - 通过.env文件管理敏感信息（API密钥等）
   - 配置XMTP网络环境（开发/生产）

2. **日志记录**
   - 记录关键操作和错误信息
   - 提供调试信息

3. **错误处理**
   - 处理网络连接问题
   - 处理API调用失败
   - 处理XMTP协议相关错误

## 技术需求

### 开发环境

- Node.js 18+（推荐18.18.0或更高版本）
- npm 8+
- Windows 10/11或Linux/macOS操作系统

### 依赖库

- `@xmtp/node-sdk` 或 `@xmtp/xmtp-js`（用于XMTP协议通信）
- `ethers`（用于钱包管理和签名）
- `dotenv`（用于环境变量管理）
- `node-fetch`（用于HTTP请求）

### XMTP SDK要求

1. 使用XMTP V3协议（V2已弃用）
2. 支持ES模块导入
3. 兼容Node.js环境

## 系统架构

### 组件结构

1. **主程序模块**
   - 初始化XMTP客户端
   - 监听消息流
   - 协调各组件工作

2. **XMTP通信模块**
   - 处理XMTP客户端创建
   - 管理消息接收和发送
   - 处理会话和对话

3. **Qwen AI接口模块**
   - 调用Qwen AI API
   - 处理响应和错误
   - 管理API密钥

4. **钱包管理模块**
   - 生成和加载钱包
   - 保存钱包信息到文件
   - 提供钱包访问接口

### 数据流

1. 程序启动
   - 加载环境变量
   - 初始化钱包
   - 创建XMTP客户端

2. 消息处理循环
   - 监听XMTP消息流
   - 接收新消息
   - 调用Qwen AI接口
   - 发送回复消息

## 安全需求

1. **密钥安全**
   - 私钥和API密钥不得硬编码在代码中
   - 使用环境变量或安全存储管理密钥
   - 确保密钥文件不被提交到版本控制系统

2. **通信安全**
   - XMTP协议本身提供端到端加密
   - 确保API调用使用HTTPS

3. **访问控制**
   - 验证消息发送者身份
   - 实现基本的垃圾消息防护

## 性能需求

1. **响应时间**
   - 从接收到消息到发送回复应在5秒内完成
   - 在网络延迟较高时应有合理的超时处理

2. **资源使用**
   - 内存占用应保持在合理范围内
   - 避免频繁的API调用以节省资源

## 部署需求

1. **本地运行**
   - 支持在开发环境中运行和测试
   - 提供详细的启动和配置说明

2. **服务器部署**
   - 支持在云服务器上长期运行
   - 提供进程管理和日志查看方案

## 测试需求

1. **单元测试**
   - Qwen AI接口模块测试
   - 钱包管理模块测试

2. **集成测试**
   - XMTP消息发送和接收测试
   - 端到端消息处理流程测试

3. **手动测试**
   - 通过另一个XMTP客户端与机器人交互
   - 验证AI回复的准确性和相关性

## 未来扩展

1. **多语言支持**
   - 支持多种语言的消息处理

2. **个性化回复**
   - 根据用户历史交互提供个性化回复

3. **插件系统**
   - 支持通过插件扩展机器人功能

4. **群聊支持**
   - 支持在群聊环境中提供服务

## 已知问题和限制

1. **XMTP SDK兼容性**
   - 在某些Node.js版本和操作系统上可能存在兼容性问题
   - 需要使用正确的SDK版本和配置

2. **网络连接**
   - XMTP网络连接可能受防火墙或代理影响
   - 在网络不稳定的环境中可能需要重试机制

3. **API限制**
   - Qwen AI API可能有调用频率限制
   - 需要实现合理的错误处理和重试机制