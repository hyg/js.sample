<!DOCTYPE html>
<html lang="zh-cn">
	<head>
		<title>ҳ</title>
		<script src="multiline.js"></script>
		<script src="js-yaml.min.js"></script>
		<script src="hashes.min.js"></script>
		<script src="openpgp.min.js"></script>
		<script src="jquery-1.12.3.min.js"></script>
		<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
		<script src="http://libs.useso.com/js/jquery/2.1.1/jquery.min.js"></script>
		<script>
			var openpgp = window.openpgp;
			var passphrase = prompt('׼ԿԿ');
			var salt = randomString(2048);
			//alert(salt);

			var MD5 = new Hashes.MD5;
			var SHA1 = new Hashes.SHA1;
			var SHA256 =  new Hashes.SHA256;
			var SHA512 = new Hashes.SHA512;
			var RMD160 = new Hashes.RMD160;
			var truepassphrase = SHA512.hex(salt + passphrase) ;
			//alert(truepassphrase);
			
			var publicKey,privateKey;
			
			
			var opt = {numBits: 512, userId: '˺ (hyg/js.sample) <test@jssample.org>', passphrase: truepassphrase};
			var keyinfo = new Object();
			keyinfo.salt = salt;
		
			openpgp.generateKeyPair(opt).then(function(key) {
				publicKey = openpgp.key.readArmored(key.publicKeyArmored).keys[0];
				privateKey = openpgp.key.readArmored(key.privateKeyArmored).keys[0];
				
				keyinfo.pubkey = key.publicKeyArmored;
				keyinfo.seckey = key.privateKeyArmored;
				var body = jsyaml.safeDump(keyinfo);
				
				$.post("http://127.0.0.1:747",body, function(data) {
					$('p').html(data);
					var res = jsyaml.safeLoad(data);
					var respublicKey = openpgp.key.readArmored(res.pubkey).keys[0];
					var resprivateKey = openpgp.key.readArmored(res.seckey).keys[0];
					var respassphrase = SHA512.hex(res.salt + passphrase) ;
					
					resprivateKey.decrypt(respassphrase);
					
					
					openpgp.signClearMessage(resprivateKey,"test string").then(function(pgpMessage){
						// success
						document.write("signed ClearMessage:<br/><pre>"+pgpMessage+"</pre><br/><br/>");
						
						pgpMessage = openpgp.cleartext.readArmored(pgpMessage);
						signTxt = pgpMessage;
						
						openpgp.verifyClearSignedMessage(respublicKey,pgpMessage).then(function(verifiedmessage){
							// success
							document.write("the text:<br/><pre>"+verifiedmessage.text+"</pre><br/><br/>");
							
							for (var i=0;i<verifiedmessage.signatures.length;i++)
							{
								document.write("Signer No. "+i+"  :\tkeyid:"+verifiedmessage.signatures[i].keyid.toHex() +"\tvalid:"+verifiedmessage.signatures[i].valid+"<br/>");
							}
						}).catch(function(error) {
							// failure
							alert("ǩ֤ʧܣ");
						});
					}).catch(function(error) {
						// failure
						alert("ǩʧܣ");
					});
				});
			});
			
			function randomString(len) {
				len = len || 32;
				var $chars = 'ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678';    /****Ĭȥ׻ַoOLl,9gq,Vv,Uu,I1****/
				var maxPos = $chars.length;
				var pwd = '';
				for (i = 0; i < len; i++) {
					pwd += $chars.charAt(Math.floor(Math.random() * maxPos));
				}
				return pwd;
			}
 		  </script>
	</head>
	<body>
		<p>aaaa</p>
	</body>
</html>