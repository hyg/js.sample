# P2P DHT Node

一个基于DHT协议的P2P节点软件，支持NAT穿透和最小化服务器依赖的通信。

## 功能特点

1. 每个节点运行在不同的局域网内，支持NAT穿透
2. 使用DHT协议发布和发现节点公网地址
3. 使用已存在的第三方中转服务器建立初始连接（在中国大陆可用）
4. 建立连接后直接P2P通信，最小化服务器依赖

## 安装

```bash
npm install
```

## 使用方法

### 启动P2P节点

```bash
npm start
# 或
npm run node
```

## 架构说明

### 组件

1. **DHT模块** (`src/dht.js`) - 使用BitTorrent DHT协议进行节点发现
2. **NAT穿透模块** (`src/nat.js`) - 使用UPnP/PMP进行端口映射
3. **节点模块** (`src/node.js`) - 核心P2P节点功能
4. **客户端** (`src/client.js`) - 程序入口

### 工作流程

1. 节点启动时会:
   - 初始化NAT穿透
   - 启动DHT客户端
   - 启动TCP监听服务器
   - 连接到第三方中转服务器进行注册

2. 节点发现:
   - 定期通过DHT协议查找其他节点
   - 尝试直接TCP连接到发现的节点

3. 通信:
   - 节点间通过TCP直接通信
   - 所有通信内容和时间都控制在最小知情范围内

## 配置

配置文件位于 `src/config.js`:

- `dht.port`: DHT协议端口 (默认6881)
- `relayServer.url`: 第三方中转服务器URL
- `node.port`: 节点监听端口 (0表示随机分配)

## 部署说明

### 节点

节点可以在任何支持Node.js的环境中运行，包括位于NAT后的局域网环境。

节点会自动连接到配置中指定的第三方中转服务器，用于初始连接建立。

### 第三方中转服务器

本软件设计为使用已存在的第三方中转服务器，而非自建服务器。在中国大陆可访问的中转服务器包括：

1. 公共BitTorrent DHT引导节点
2. WebRTC信令服务器
3. 其他P2P网络的中转服务

在`src/config.js`中配置合适的服务器URL。

## 隐私保护

- 节点间的直接通信不经过服务器
- 通信时间和内容长度信息被最小化
- 只有必要的节点信息会通过DHT网络发布

## 故障排除

### NAT穿透问题

如果NAT穿透失败，节点仍然可以通过中转服务器进行通信。

### DHT网络连接问题

如果DHT网络中没有其他节点，节点发现功能可能无法正常工作。请确保网络中至少有一个其他节点在线。

## 依赖说明

- `bittorrent-dht`: BitTorrent DHT协议实现
- `nat-upnp`: UPnP/NAT-PMP端口映射
- `ws`: WebSocket客户端，用于连接中转服务器